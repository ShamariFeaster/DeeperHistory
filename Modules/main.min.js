(function(){var d=structureJS.require;var E="System.Define";var w=function(){};var q=d("IdbClient");var J=d("Tab");var x=d("Utility");var k=d("Port");var l=d("State");var o=d("String");var t=d("Crypto");var n=null;function A(){}function F(R,K,M,S){var Q=null;var O="";var T="";for(var L in R){if(L!="decoration"&&L!=M){console.log("Diffing: "+L+" to "+M);try{Q=S.diff_main(R[L]["buffer"],K.buffer);S.diff_cleanupSemantic(Q);for(var N in Q){if(Q[N][0]==0){O+=Q[N][1]}}console.log("Host decoration: "+O);if(O.length>T.length){T=O;console.log("New Host decoration: "+T)}O=""}catch(P){console.log("Error diffing. Returning empty array as Diff result");console.log(P);R.decoration=""}}}R.decoration=T}function m(K){var L=J.currId();if(k.addPort(L,K)){x.debug(2,E,"runtimeOnConnect","Port pushed onto Map");x.debug(2,E,"runtimeOnConnect","onConnect tabId: "+L);x.debug(2,E,"runtimeOnConnect","channel open on port#: "+K.portId_)}else{x.debug(1,E,"runtimeOnConnect","ERROR: Problem adding port to map")}k.postMessageToPort(J.currId(),{changeHighlightColor:localStorage.highlightColor});K.onMessage.addListener(function(S){for(var aa in S){var Y=aa}switch(Y){case"setRawPage":S=S.setRawPage;var M=new diff_match_patch();var P,U,ad,R,V,W,ae,X,O,ab=false,N={},Q=false,Z="";Z=o.getHostName(S.url);P=U=S.timestamp;R=O=S.url;X=l.persist("cache")["sites"][Z];W=X[R];W.buffer=o.sanitize(S.html);ae=S.title;if(W.init["html"]==""){console.log("STORING INIT HTML");var T=W.buffer.length;if(typeof X.decoration=="undefined"){F(X,W,O,M)}else{if(X.decoration.length<((parseFloat(T)*l.TARGET_COMPRESSION))){console.log("INSUFFICIENT COMPRESSION: "+(X.decoration.length/T));F(X,W,O,M)}}if(typeof X.decoration!="undefined"){console.log(X.decoration.length+" "+((parseFloat(T)*l.TARGET_COMPRESSION)))}console.log("BEFORE DR: "+((W.buffer.length*16)/(8*1024)).toPrecision(3)+"kB");if(typeof X.decoration!="undefined"){W.buffer=o.removeDecoration(W.buffer,X.decoration)}console.log("AFTER DR: "+((W.buffer.length*16)/(8*1024)).toPrecision(3)+"kB");console.log("FINAL COMPRESSION: "+(X.decoration.length/T));W.init["html"]=W.buffer;W.init["timestamp"]=P;W[P]=W.buffer;W.title=ae;N.url=R;N.timestamp=P;if(l.isExtenstionEnabled()==true){l.persist("processQueue").push(N)}}else{console.log("BEFORE DR: "+((W.buffer.length*16)/(8*1024)).toPrecision(3)+"kB");if(typeof X.decoration!="undefined"){W.buffer=o.removeDecoration(W.buffer,X.decoration)}console.log("AFTER DR: "+((W.buffer.length*16)/(8*1024)).toPrecision(3)+"kB");try{ad=M.diff_main(W.init["html"],W.buffer);M.diff_cleanupSemantic(ad)}catch(ac){console.log("Error diffing. Returning empty array as Diff result");console.log(ac);ad=[]}console.log(M.DIFF_EQUAL);for(var aa in ad){if(ad[aa][0]==1){console.log("***DIFF INSERTION Found****: "+ad[aa][1]);W[P]=ad[aa][1];N.url=R;N.timestamp=P;Q=true;ab=true}else{if(ad[aa][0]==-1){Q=true}else{if(ad[aa][0]==0){}}}}if(Q){W.init["html"]=W.buffer;console.log("Diff Found")}else{console.log("No Diff Found")}if(ab&&l.isExtenstionEnabled()==true){l.persist("processQueue").push(N);console.log("PROCESS QUEUE");console.log(l.persist("processQueue"))}else{console.log("No Insertion Found. No Queue Actions")}}console.log("PROCESS QUEUE");break;case"mouseMoveDetected":S=S.mouseMoveDetected;l.lastMouseMove((new Date()).getTime());break;case"stopHighlightLoop":S=S.stopHighlightLoop;console.log("Highlight Loop Stopped");clearInterval(l.highlightLoop());break;case"startHighlightLoop":S=S.startHighlightLoop;console.log("startHighlightLoop Started");clearInterval(l.highlightLoop());l.highlightLoop(setInterval(function(){console.log("Trying To Post: "+S);k.postMessageToPort(J.currId(),{highlight:{word:S}})},1500));break}});K.onDisconnect.addListener(function(){var N=(typeof K=="undefined")?"undefined":K.portId_;var M=-1;x.debug(2,E,"runtimeOnConnect","CLOSED:: Port for tab# "+L+", port# "+N+" has been closed");if(N!="undefined"){x.debug(2,E,"runtimeOnConnect","REOPENING: port for tab# "+L+" .Re-executing content script.");if(k.hasPorts(L)){M=k.getTabPorts(L).indexOf(K)}if(M>-1){k.getTabPorts(L).splice(M,1)}try{chrome.tabs.executeScript(L,{file:"core.js"})}catch(O){x.debug(1,E,"runtimeOnConnect","ERROR: Trying to re-execute content script on tab.")}}})}function f(L,K){}function g(K){}function i(K){J.currId(K.id);J.currTitle(K.title);console.log("Tab created "+J.currId());if(J.currTitle()==null){J.currId(K.id);J.currTitle(K.title)}}function y(K){if(typeof K!="undefined"){chrome.tabs.get(K.tabId,function(M){var P=d("State");var L=d("Port");var O=J.currId();L.postMessageToPort(O,{turnOffShift:true});J.currId(M.id);J.lastId(J.currId());J.currTitle(M.title);P.currPageUrl(M.url);x.log("tabsOnActivated",x.printf("Current Tab#: %s Activated. Last Tab# %s Has Port Open: %s Page Title: %s, url: %s",J.currId(),J.lastId(),L.hasPorts(J.currId()),J.currTitle(),P.currPageUrl()),E,2);try{chrome.tabs.executeScript(M.id,{file:"lib/jquery.js"},function(){chrome.tabs.executeScript(M.id,{file:"core.js"},function(){x.log("tabsOnActivated","Tab Activated and script run.",E,1);L.postMessageToPort(M.id,{changeHighlightColor:localStorage.highlightColor})})})}catch(N){x.debug(1,E,"runtimeOnConnect","ERROR: Trying to re-execute content script on tab.")}})}}function G(K,L){x.debug(1,E,"tabOnRemoved","TAB CLOSED: Removing port of tab# "+K+" from tab#-to-portObj table. Table is now: ");k.removePorts(K);if(J.currId()==K){J.isOpen(false)}}function s(L,K,M){function N(S){if(typeof l.persist("cache")["sites"][o.getHostName(S)]=="undefined"){l.persist("cache")["sites"][o.getHostName(S)]={}}var T=l.persist("cache")["sites"][o.getHostName(S)];var U=(new Date()).getTime();var Q={html:"",timestamp:U};var R={init:Q,buffer:""};if(typeof T[S]=="undefined"){T[S]=R}return U}if(K.status=="loading"){J.currId(M.id)}if(K.status=="complete"){J.lastId(J.currId);J.currId(M.id);J.currId(M.id);J.currTitle(M.title);l.currPageUrl(M.url);var P=o.getHostName(M.url);if(P!="www.google.com"){var O=N(M.url);k.postMessageToPort(J.currId(),{getRawPage:{timestamp:O,url:M.url,title:M.title}})}x.log("tabsOnUpdated",x.printf("Tab Finished Updating. Tab ID: %s. Tab Title: %s, url: %s",J.currId(),J.currTitle(),l.currPageUrl()),E,2)}}function H(O,M){if(O==-1||typeof O=="undefined"){return}if(l.secDiff(M)>1){T.splice(0,1,O);console.log("Could not removing articles in alloted time. Placing back on queue. Returning");H(-1)}var K,U,L,X="",V="",W,P,R,N,T=l.persist("processQueue"),S=null,Q="";K=O.url;U=O.timestamp;L=l.persist("cache")["sites"][o.getHostName(K)][K];if(typeof L!="undefined"){if(L[U]!=""){Q=t.encrypt(L[U]);var Y=((Q.length*16)/(8*1024)).toPrecision(3);S={timestamp:U,url:K,terms:Q,title:L.title,size:Y,encrypted:true};if(l.lastKeyAdded()==U){U++}q.addRecord(S,function(aa){var Z=l.persist("searchCache");l.dbSize(l.dbSize()+parseFloat(Y));l.cacheSize(l.cacheSize()+parseFloat(Y));aa.terms=L[U];Z.push(aa);l.lastKeyAdded(aa.timestamp);console.log('QUEUE EMPTY: Finished processing "'+aa.title+'" It is '+aa.size+"kb. "+l.secDiff(M)+" Sec");MMCD_USAGE.processOccuranceByUser(MMCD_USAGE.EVENTS.page_indexed)})}else{console.log("DB Entry Rejected: Empty Input")}if(T.length>0){W=T.splice(0,1)[0];H(W,M)}else{H(-1)}}else{console.log("Site was undefined")}}function D(){var L,K=l.persist("processQueue");if(K.length>0){L=K.splice(0,1)[0];H(L,l.currentTime())}}function C(){console.log("tick");var K=l.currentTime()-l.lastMouseMove();var L=l.persist("processQueue");if(K>=l.PROCESS_DELAY_TIME&&L.length>0&&l.isExtenstionEnabled()==true){console.log("Processing Queue Now");l.lastMouseMove(l.currentTime());D()}}function r(){MMCD_USAGE.processOccuranceByUser(MMCD_USAGE.EVENTS.search_occurance)}function z(N,M){var L=[];switch(N){case".hl":chrome.omnibox.setDefaultSuggestion({description:"<dim>Change Your Selection Color Below</dim>"});L.push({content:".hl-default",description:"<match>Default Color</match>"});L.push({content:".hl-yellow",description:"<match>Yellow</match>"});L.push({content:".hl-green",description:"<match>Green</match>"});L.push({content:".hl-blue",description:"<match>Blue</match>"});return L;break;case".dsize":var K=(l.dbSize()>1000)?(l.dbSize()/1000).toFixed(2)+"MB":l.dbSize().toFixed(2)+"kB";chrome.omnibox.setDefaultSuggestion({description:"<dim>Your Deeper History DB Size Is: "+K+"</dim>"});return L;break;case".csize":var K=(l.cacheSize()>1000)?(l.cacheSize()/1000).toFixed(2)+"MB":l.cacheSize().toFixed(2)+"kB";chrome.omnibox.setDefaultSuggestion({description:"<dim>Your Deeper History Cache Size Is: "+K+"</dim>"});return L;break;case".options":chrome.omnibox.setDefaultSuggestion({description:"<dim>Please Select An Option From Below</dim>"});L.push({content:(JSON.parse(localStorage.updateInfo).update_video||"http://www.youtube.com/watch?v=Ujvd_jZkXZ4"),description:"<match>Learn The New Features. Select Me Watch The Latest Update Video</match>"});L.push({content:(JSON.parse(localStorage.updateInfo).bug_report_url||"https://chrome.google.com/webstore/support/aohgidnfhlaciophgjldellglmocdkfn?hl=en&gl=US#bug"),description:"<match>Report A Bug</match>"});L.push({content:(JSON.parse(localStorage.updateInfo).dev_twitter||"https://twitter.com/shamari_feaster"),description:"<match>Hit The Dev Up On Twitter</match>"});L.push({content:(JSON.parse(localStorage.updateInfo).website_url||"http://lariattech.com"),description:"<match>Learn About - Lariat Tech - The Company That Makes Deeper History</match>"});L.push({content:"options.html",description:"<match>Go To The Options Page</match>"});l.matchFound(true);MMCD_USAGE.processOccuranceByUser(MMCD_USAGE.EVENTS.dot_options_command);return L;break}}function e(X,U){var L=null;if((L=z(X))){U(L);return}chrome.omnibox.setDefaultSuggestion({description:'<dim>Searching Your History For "<match>'+X+'"</match></dim>'});var W=o.wordsToRemove;for(var ad in W){X=X.replace(new RegExp("\\b"+W[ad]+"\\b","gi")," ")}var X=X.toLowerCase();var S=null;var aa=[];var ak={};var K=l.persist("searchCache");var O=null;var P="";if(X.indexOf(" ")!=-1){console.log("Space found");X=X.replace(/\s+/,"\\s")}console.log(X);if(X.indexOf(",")!=-1){var Q=X.split(",");for(var ad in Q){if(Q[ad]&&Q[ad]!="\\s"){P+="(\\b"+Q[ad]+".*?\\b)";P+="|"}}P=P.substr(0,P.lastIndexOf("|"));O=new RegExp(P,"i")}else{if(X=="\\s"){O=new RegExp("-(REMOVED WORD)-","i")}else{O=new RegExp("\\b"+X+".*?\\b","i")}}console.log("REGEX: "+O);var ah=null;var ac="";var Z={};var R=[];var V={};var N={};for(var ad in K){S=K[ad].terms;if(X.length>1&&(ah=O.exec(K[ad].terms))!=null){ac=ah[0].toLowerCase().trim();Z[ac]=ac;if(typeof N[K[ad].title]=="undefined"){N[K[ad].title]=true;V.title=K[ad].title;V.link='<a data-match="'+ac+'" href="'+K[ad].url+'" style="font-size: 25px;">'+K[ad].title+"</a>";V.match=ac;K[ad]["match"]=ac;var ag=new Date(K[ad].timestamp);var ai=ag.getMonth()+1;var ab=((""+ag.getMinutes()).length==1)?"0"+ag.getMinutes():ag.getMinutes();var ae=((""+ag.getHours()).length==1)?"0"+ag.getHours():ag.getHours();V.date=ai+"-"+ag.getDate()+"-"+ag.getFullYear()+" "+ae+":"+ab;aa.push(K[ad]);R.push(V);V={}}}}ac="";for(var af in Z){ac+=" "+af}ac=ac.trim();console.log("Results");console.log(aa);ak.searchTerms=ac;ak.results=R;localStorage.resultCache=JSON.stringify(ak);var Y=[];var aj="";var M="";var T=null;for(var ad in aa){aj=(aa[ad].title).replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/&/g,"&amp;");T=aa[ad].match;if(aa.length>3&&ad<1){Y.push({content:"more-results.html",description:"<match>Select Me See The Rest Of The Results</match>"})}else{if(T){Y.push({content:aa[ad].url+"|"+T,description:"<match>DeeperHistory Match: <dim>"+T+"</dim> </match>"+aj})}}}if(Y.length>0){console.log(Y.length+" Suggestions Found");chrome.omnibox.setDefaultSuggestion({description:"<dim>Found "+Y.length+' Matche(s) For "<match>'+ac+'"</match></dim>'});console.log(Y);l.matchFound(true)}else{console.log("Suggestions NOT Found");l.matchFound(false);if(X=="\\s"){chrome.omnibox.setDefaultSuggestion({description:"No Matches Found Because This Word Is So Common It Is Not Stored In Your Databse"})}else{chrome.omnibox.setDefaultSuggestion({description:'<dim>No Matches Found For <match>"'+X+'"</match> In Your History</dim> <match>Select Me To Go To The Options Page</match>'})}}U(Y)}function p(){console.log("onInputCancelled");chrome.omnibox.setDefaultSuggestion({description:'<dim>Type ".help" For Instructions</dim>'})}function b(N){var M=N.split("|");var L=M[0];var K=M[1];console.log("parts: "+L+" "+K);switch(L){case".db":console.log("DB Found");chrome.tabs.update(J.currId(),{url:"database.html"});break;case".help":chrome.tabs.update(J.currId(),{url:"help.html"});break;case".hl-default":localStorage.highlightColor="default";k.postMessageToPort(J.currId(),{changeHighlightColor:"default"});break;case".hl-yellow":localStorage.highlightColor="yellow";k.postMessageToPort(J.currId(),{changeHighlightColor:"yellow"});break;case".hl-blue":localStorage.highlightColor="blue";k.postMessageToPort(J.currId(),{changeHighlightColor:"blue"});break;case".hl-green":localStorage.highlightColor="green";k.postMessageToPort(J.currId(),{changeHighlightColor:"green"});break;default:if(!l.matchFound()){L="options.html"}else{if(L!="more-results.html"){MMCD_USAGE.processOccuranceByUser(MMCD_USAGE.EVENTS.match_selected)}}chrome.omnibox.setDefaultSuggestion({description:'<dim>Type ".help" For Instructions</dim>'});chrome.tabs.update(J.currId(),{url:L},function(O){clearInterval(l.highlightLoop());l.highlightLoop(setInterval(function(){k.postMessageToPort(O.id,{highlight:{word:K}})},1500))});break}}function B(){MMCD_USAGE.processOccuranceByUser(MMCD_USAGE.EVENTS.power_button);if(l.isExtenstionEnabled()==true){console.log("Exttension disabled: "+l.isExtenstionEnabled());chrome.browserAction.setTitle({title:"Deeper History Is Off. Press To Turn On.\n\nGo To chrome://extensions And Visit The\nDeeper History Options Page To Learn More\nAbout This Feature"});l.isExtenstionEnabled(false);chrome.browserAction.setIcon({path:{19:"images/DH-BA-19px-off.png",38:"images/DH-BA-19px-off.png"}})}else{console.log("Exttension enabled: "+l.isExtenstionEnabled());chrome.browserAction.setTitle({title:"Deeper History Is On. Press To Turn Off.\n\nGo To chrome://extensions And Visit The\nDeeper History Options Page To Learn More\nAbout This Feature"});l.isExtenstionEnabled(true);chrome.browserAction.setIcon({path:{19:"images/DH-BA-19px-on.png",38:"images/DH-BA-19px-on.png"}})}}var h={onUpdated:s,onRemoved:G,onCreated:i,onActivated:y};var u={onStartup:null,onInstalled:null,onConnect:m};var v={onCommand:g};var I={onClicked:f};var c={onInputEntered:b,onInputChanged:e,onInputStarted:r,onInputCancelled:p};var j={onClicked:B};var a={tabs:h,runtime:u,command:v,context:I,omnibox:c,browserAction:j};chrome.browserAction.onClicked.addListener(a.browserAction.onClicked);chrome.runtime.onConnect.addListener(a.runtime.onConnect);chrome.runtime.onStartup.addListener(a.runtime.onStartup);chrome.tabs.onRemoved.addListener(a.tabs.onRemoved);chrome.tabs.onCreated.addListener(a.tabs.onCreated);chrome.tabs.onActivated.addListener(a.tabs.onActivated);chrome.tabs.onRemoved.addListener(a.tabs.onRemoved);chrome.tabs.onUpdated.addListener(a.tabs.onUpdated);chrome.omnibox.onInputStarted.addListener(a.omnibox.onInputStarted);chrome.omnibox.onInputEntered.addListener(a.omnibox.onInputEntered);chrome.omnibox.onInputChanged.addListener(a.omnibox.onInputChanged);chrome.omnibox.onInputCancelled.addListener(a.omnibox.onInputCancelled);chrome.omnibox.setDefaultSuggestion({description:'<dim>Type ".help" For Instructions</dim>'});(function(){setInterval(C,1000);l.ls("DeepHistoryVersion",16);l.ls("highlightColor","default");q=new q("DeepHistory",l.ls("DeepHistoryVersion"),"DeepHistoryIndex");function K(N){var O=this;if(typeof N.encrypted==="undefined"){N.encrypted=false;O.updateRecord(N)}}function L(){var O=this;var N=O.db.objectStoreNames;for(var P in N){if(N[P]=="DeepHistoryIndex"){console.log("Store: DeepHistoryIndex Exits. DELTING IT");O.db.deleteObjectStore("DeepHistoryIndex")}}O.db.createObjectStore("DeepHistoryIndex",{keyPath:"timestamp"})}function M(N){switch(parseInt(N)){case 16:q.forEach(K);break}}q.setUpgradeNeeded(function(N){q.initDb(N.target.result);console.log("onupgradeneeded  fired On Version: "+l.ls("DeepHistoryVersion"))});q.open(function(){M(l.ls("DeepHistoryVersion"));var N=l.persist("searchCache");var S=[];var P=0;var Q=0;var O=700;var R=l.currentTime();console.log("PUTTING TERMS INTO SEARCH CACHE");q.forEach(function(T){if(l.currentTime()-T.timestamp<l.MAX_AGE){if(typeof T.encrypted!=="undefined"&&T.encrypted==true){T.terms=t.decrypt(T.terms)}N.push({timestamp:T.timestamp,url:T.url,terms:T.terms,title:T.title,size:T.size});Q+=parseFloat(T.size)}P+=parseFloat(T.size);S.push(T)},function(){l.dbSize(P);l.cacheSize(Q);console.log(">>> FINISHED PUTTING TERMS INTO SEARCH CACHE IN "+l.secDiff(R)+"sec");console.log("DB size is "+P+"kB");console.log("MAX_DB_SIZE is "+O+"kB");l.persist("searchCache",N);console.log(N)})});chrome.permissions.remove({permissions:["history"]},function(N){if(N==true){console.log("History permission is removed")}})})()})();